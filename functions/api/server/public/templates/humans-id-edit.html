<!doctype html>
<html lang="en" class="h-full antialiased">
<head>
    <title>Edit {{ .Human.Name }} | AsianAmericans.wiki</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" href="/favicon.ico" type="image/x-icon" />
    <link href="/output.css?v=2" rel="stylesheet" />
    <script src="/1.9.10.htmx.min.js"></script>
    {{ template "dark-mode.html" . }}
</head>
<body class="flex flex-col min-h-screen bg-[var(--color-background)] text-[var(--color-text)] font-body">
    {{ template "header.html" . }}

    <main class="flex-grow container mx-auto px-4 py-12">
        <div class="max-w-4xl mx-auto bg-[var(--color-card-bg)] rounded-2xl shadow-lg border border-[var(--color-border)] p-8">
            <h1 class="text-3xl font-bold font-heading text-[var(--color-text)] mb-8 text-center">Edit Human: {{ .Human.Name }}</h1>

            <form action="/humans/{{ .Human.ID }}" method="post" enctype="multipart/form-data" class="space-y-6">
                <!-- Image Upload & Preview -->
                <div class="flex flex-col items-center gap-4 py-6 border-b border-[var(--color-border)]">
                    <div class="relative group">
                        <div class="w-48 h-48 rounded-xl overflow-hidden border-2 border-dashed border-[var(--color-border)] bg-[var(--color-background)] flex items-center justify-center">
                            <img id="image" class="w-full h-full object-cover hidden" />
                            {{ if .Human.Images.Featured }}
                                <img src="{{ .Human.Images.Featured }}" class="w-full h-full object-cover group-[.new-image-loaded]:hidden" id="current-featured" />
                            {{ else }}
                                <span class="text-[var(--color-text-secondary)] group-[.new-image-loaded]:hidden">No image</span>
                            {{ end }}
                        </div>
                    </div>
                    
                    <div class="flex flex-col items-center">
                        <label class="cursor-pointer bg-[var(--color-primary)] text-white px-4 py-2 rounded-lg hover:bg-[var(--color-primary-hover)] transition-colors text-sm font-semibold">
                            Change Featured Image
                            <input type="file" id="featured_image" name="upload" class="hidden" accept="image/*" />
                        </label>
                        <p class="text-[var(--color-text-secondary)] text-xs mt-2">Recommended: Square aspect ratio, high resolution</p>
                    </div>

                    <!-- Hidden fields for processed images -->
                    <input type="file" name="featured_image" id="featured_image_field" class="hidden" />
                    <input type="file" name="thumbnail" id="thumbnail_field" class="hidden" />
                </div>

                <!-- Description -->
                <div>
                    <label for="description" class="block text-sm font-medium text-[var(--color-text-secondary)] uppercase tracking-wider mb-2">Description</label>
                    <textarea name="description" id="description" rows="12" class="w-full p-4 rounded-lg bg-[var(--color-background)] border border-[var(--color-border)] text-[var(--color-text)] focus:ring-2 focus:ring-[var(--color-primary)] outline-none transition-all leading-relaxed">{{ .Human.Description }}</textarea>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 pt-6 border-t border-[var(--color-border)]">
                    <!-- ID (Read only) -->
                    <div>
                        <label class="block text-sm font-medium text-[var(--color-text-secondary)] uppercase tracking-wider mb-2">ID</label>
                        <input type="text" value="{{ .Human.ID }}" disabled class="w-full p-3 rounded-lg bg-[var(--color-background)] border border-[var(--color-border)] text-[var(--color-text-secondary)] opacity-60 cursor-not-allowed text-sm" />
                    </div>

                    <!-- Name -->
                    <div>
                        <label for="name" class="block text-sm font-medium text-[var(--color-text-secondary)] uppercase tracking-wider mb-2">Name</label>
                        <input type="text" name="name" id="name" value="{{ .Human.Name }}" required class="w-full p-3 rounded-lg bg-[var(--color-background)] border border-[var(--color-border)] text-[var(--color-text)] focus:ring-2 focus:ring-[var(--color-primary)] outline-none transition-all" />
                    </div>

                    <!-- Date of Birth -->
                    <div>
                        <label for="dob" class="block text-sm font-medium text-[var(--color-text-secondary)] uppercase tracking-wider mb-2">Date of Birth</label>
                        <input type="text" name="dob" id="dob" value="{{ .Human.DOB }}" placeholder="YYYY-MM-DD" class="w-full p-3 rounded-lg bg-[var(--color-background)] border border-[var(--color-border)] text-[var(--color-text)] focus:ring-2 focus:ring-[var(--color-primary)] outline-none transition-all" />
                    </div>

                    <!-- Gender -->
                    <div>
                        <label for="gender" class="block text-sm font-medium text-[var(--color-text-secondary)] uppercase tracking-wider mb-2">Gender</label>
                        <select name="gender" id="gender" class="w-full p-3 rounded-lg bg-[var(--color-background)] border border-[var(--color-border)] text-[var(--color-text)] focus:ring-2 focus:ring-[var(--color-primary)] outline-none transition-all">
                            <option value="male" {{ if eq .Human.Gender "male" }}selected{{ end }}>Male ♂️</option>
                            <option value="female" {{ if eq .Human.Gender "female" }}selected{{ end }}>Female ♀️</option>
                            <option value="nonbinary" {{ if eq .Human.Gender "nonbinary" }}selected{{ end }}>Non-binary ☿️</option>
                        </select>
                    </div>
                </div>

                <!-- Ethnicity -->
                <div class="pt-6 border-t border-[var(--color-border)]">
                    <label class="block text-sm font-medium text-[var(--color-text-secondary)] uppercase tracking-wider mb-2">Ethnicity</label>
                    <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2">
                        {{$humanEth := .Human.Ethnicity}}
                        {{ range $eth := .HumanFormFields.Ethnicities }}
                        <label class="flex items-center space-x-2 p-2 rounded-lg hover:bg-[var(--color-background)] cursor-pointer border border-transparent hover:border-[var(--color-border)] transition-all">
                            <input type="checkbox" name="ethnicity" value="{{ $eth.Ethnicity }}" {{ if slicesContains $humanEth $eth.Ethnicity }}checked{{ end }} class="rounded border-[var(--color-border)] text-[var(--color-primary)] focus:ring-[var(--color-primary)]" />
                            <span class="text-sm text-[var(--color-text)] capitalize">{{ $eth.Ethnicity }} {{ $eth.Emoji }}</span>
                        </label>
                        {{ end }}
                    </div>
                </div>

                <!-- Tags -->
                <div class="pt-6 border-t border-[var(--color-border)]">
                    <label for="tags" class="block text-sm font-medium text-[var(--color-text-secondary)] uppercase tracking-wider mb-2">Tags</label>
                    {{$humanTags := .Human.Tags}}
                    <select name="tags" id="tags" multiple size="8" class="w-full p-3 rounded-lg bg-[var(--color-background)] border border-[var(--color-border)] text-[var(--color-text)] focus:ring-2 focus:ring-[var(--color-primary)] outline-none transition-all mb-2">
                        {{ range .HumanFormFields.Tags }}
                        <option value="{{ . }}" {{ if slicesContains $humanTags . }}selected{{ end }}>{{ . }}</option>
                        {{ end }}
                    </select>
                    <input type="text" name="tags-other" placeholder="Add other tags (comma separated)..." class="w-full p-3 rounded-lg bg-[var(--color-background)] border border-[var(--color-border)] text-[var(--color-text)] focus:ring-2 focus:ring-[var(--color-primary)] outline-none transition-all text-sm" />
                </div>

                <!-- Socials -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 pt-6 border-t border-[var(--color-border)]">
                    <div>
                        <label for="x" class="block text-sm font-medium text-[var(--color-text-secondary)] uppercase tracking-wider mb-2">X (Twitter) URL</label>
                        <input type="text" name="x" id="x" value="{{ .Human.Socials.X }}" placeholder="https://x.com/username" class="w-full p-3 rounded-lg bg-[var(--color-background)] border border-[var(--color-border)] text-[var(--color-text)] focus:ring-2 focus:ring-[var(--color-primary)] outline-none transition-all text-sm" />
                    </div>
                    <div>
                        <label for="instagram" class="block text-sm font-medium text-[var(--color-text-secondary)] uppercase tracking-wider mb-2">Instagram URL</label>
                        <input type="text" name="instagram" id="instagram" value="{{ .Human.Socials.Instagram }}" placeholder="https://instagram.com/username" class="w-full p-3 rounded-lg bg-[var(--color-background)] border border-[var(--color-border)] text-[var(--color-text)] focus:ring-2 focus:ring-[var(--color-primary)] outline-none transition-all text-sm" />
                    </div>
                    <div>
                        <label for="imdb" class="block text-sm font-medium text-[var(--color-text-secondary)] uppercase tracking-wider mb-2">IMDB URL</label>
                        <input type="text" name="imdb" id="imdb" value="{{ .Human.Socials.IMDB }}" placeholder="https://imdb.com/name/nm..." class="w-full p-3 rounded-lg bg-[var(--color-background)] border border-[var(--color-border)] text-[var(--color-text)] focus:ring-2 focus:ring-[var(--color-primary)] outline-none transition-all text-sm" />
                    </div>
                    <div>
                        <label for="website" class="block text-sm font-medium text-[var(--color-text-secondary)] uppercase tracking-wider mb-2">Website URL</label>
                        <input type="text" name="website" id="website" value="{{ .Human.Socials.Website }}" placeholder="https://example.com" class="w-full p-3 rounded-lg bg-[var(--color-background)] border border-[var(--color-border)] text-[var(--color-text)] focus:ring-2 focus:ring-[var(--color-primary)] outline-none transition-all text-sm" />
                    </div>
                </div>

                <!-- Actions -->
                <div class="flex flex-col sm:flex-row gap-4 pt-8 border-t border-[var(--color-border)]">
                    <button type="submit" class="flex-grow bg-[var(--color-primary)] text-white font-bold py-3 px-6 rounded-xl hover:bg-[var(--color-primary-hover)] transition-all shadow-lg shadow-[var(--color-primary)]/20">
                        Save Changes
                    </button>
                    <button type="button" onclick="window.history.back();" class="flex-grow bg-[var(--color-background)] text-[var(--color-text)] font-bold py-3 px-6 rounded-xl border border-[var(--color-border)] hover:bg-gray-100 dark:hover:bg-gray-800 transition-all">
                        Cancel
                    </button>
                    <button type="button" 
                        hx-delete="/humans/{{ .Human.ID }}" 
                        hx-confirm="Are you sure you want to delete {{ .Human.Name }}? This action cannot be undone."
                        class="flex-grow bg-red-600 text-white font-bold py-3 px-6 rounded-xl hover:bg-red-700 transition-all shadow-lg shadow-red-600/20">
                        Delete Human
                    </button>
                </div>
            </form>
        </div>
    </main>

    {{ template "footer.html" . }}

    <!-- CropperJS -->
    <link href="https://unpkg.com/cropperjs@1.5.13/dist/cropper.min.css" rel="stylesheet" />
    <script src="https://unpkg.com/cropperjs@1.5.13/dist/cropper.min.js"></script>

    <script>
      const fileInput = document.getElementById("featured_image");
      const image = document.getElementById("image");
      const currentFeatured = document.getElementById("current-featured");
      const fieldFeatured = document.getElementById("featured_image_field");
      const fieldThumb = document.getElementById("thumbnail_field");

      let cropper;

      fileInput.addEventListener("change", async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        image.src = URL.createObjectURL(file);
        image.style.display = "block";
        if (currentFeatured) currentFeatured.style.display = "none";
        document.querySelector('.group').classList.add('new-image-loaded');

        const setFileInput = (input, file) => {
          const dt = new DataTransfer();
          dt.items.add(file);
          input.files = dt.files;
        };

        if (cropper) cropper.destroy();

        await new Promise((resolve) => {
          image.onload = () => {
            cropper = new Cropper(image, {
              aspectRatio: 1,
              viewMode: 1,
              autoCropArea: 1,
              cropend: async function (event) {
                const croppedCanvas = cropper.getCroppedCanvas({
                  width: 256,
                  height: 256,
                  imageSmoothingEnabled: true,
                  imageSmoothingQuality: "high",
                });

                const croppedBlob = await new Promise((resolve) => {
                  croppedCanvas.toBlob((blob) => resolve(blob), "image/webp", 0.9);
                });
                const thumbFile = new File([croppedBlob], "thumbnail.webp", { type: "image/webp" });
                setFileInput(fieldThumb, thumbFile);
              },
            });
            resolve();
          };
        });

        // Convert full image to WebP
        const originalBlob = await new Promise((resolve) => {
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement("canvas");
            canvas.width = img.width;
            canvas.height = img.height;
            const ctx = canvas.getContext("2d");
            ctx.drawImage(img, 0, 0);
            canvas.toBlob((blob) => resolve(blob), "image/webp", 0.9);
          };
          img.src = image.src;
        });

        const featuredFile = new File([originalBlob], "featured.webp", { type: "image/webp" });
        setFileInput(fieldFeatured, featuredFile);
      });
    </script>
</body>
</html>